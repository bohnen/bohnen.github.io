---
layout: post
title: "OSXでeTax"
date: 2014-02-08 22:18:54 +0900
comments: true
categories: 
---

OSX(Mavericks) でeTaxを使い確定申告を行った時のメモ。ちょっと工夫が必要だった。
（なお、本手順はeTaxが推奨している方法でもなんでもない（OSX 10.9はサポートされていない）ので、
適用は自己責任で）

<!--more-->

## ハード

住民基本台帳カードリーダーには、 Gemaltoの USB-TR を利用した。このリーダーは、元々去年まで
WindowsでeTaxをするのに使っていたものだが、OSXにも対応していて、特に何もインストールをしなくても認識する。

## 下準備

まずはJREをインストールする必要がある。それ以外にも、住民基本台帳カードの準備やeTaxの利用申請が必要だけど、ここでは割愛。

* [Java Runtimeのインストール](http://www.java.com/ja/download/index.jsp)

## JPKIクライアントソフトのインストール

* [JPKIクライアントソフトのインストール](http://www.jpki.go.jp/download/)

上記ページにある手順通りにやればJPKIクライアントソフトがインストールできる。

*アプリケーション/ユーティリティ/公的個人認証サービス/* にツールがインストールされている。特にプロキシ等必要ない環境なので、

1. Java実行環境への登録
2. JPKI利用者ソフト

の順に実行すれば、JPKI利用者ソフトが起動できる。ただ、この段階で「動作確認」を行っても、JPKI.tokendが起動しない。

（エラーについては、 http://www.jpki.go.jp/download/howto_mac/confirm_p02.html を参照）

JPKI.tokendを立ち上げるためには、追加でインストールをしないといけなかった（Appleのフォーラムには
前のバージョンのOSXからコピーするような情報もあったが、前のバージョンのOSXが無かったので・・・）

## SmartCard Servicesのインストール

MacOS forgeから、Smartcard Servicesをインストールする。これにより、JPKI.tokendがインストールされる。

http://smartcardservices.macosforge.org/trac/wiki/installers から、OS X Mavericks 10.9 用のバイナリを取得し、インストールする。

インストール後カードを挿すと、カードの内容（証明書等）がキーチェーンに登録される。そのため、様々なアプリケーションが
キーチェーンのキーを使おうとしてパスワードを要求するダイアログを出してくる。

ここで入力するパスワードは、住民基本台帳カードに設定したprivate key用のパスワードなので注意。
いくつもパスワードを設定しないといけないこの仕様はどうにかならないかなぁ。

ここまでで、カードの読み取りはできるはず。

## ルート証明書のインストール

http://www.nta.go.jp/tetsuzuki/shinkoku/shotoku/tokushu/jyunbi.htm#junbi2

キーチェーンに、「システム」が無かったので、「システムルート」にいれた。特に問題になっていないみたいだ。
ルート証明書が設定されたら、JPKI利用者ソフトを立ち上げ、自分の証明書を表示。右下にある、**「有効性確認」** を実施する。
有効と表示されれば、問題ないはずだ。

## トラブルシューティング

トラブルシューティングを行うときは、JPKI利用者ソフトの **「動作確認」** を実行するのが基本。ここでOKであれば、
基本eTaxでも動く。

### カードを認識しないとき

リーダーを差し込むときにカードを挿さない。リーダーを差し込むとLEDが点滅するので、そこでカードを差し込むとLEDが点灯したままになる。この状態じゃないとカードは認識されない。

### eTax(Web版)が使えない

これは何回かトライしたけどダメで、あきらめた。起動まではいくんだけど、対応環境は×、Javaの起動もなぜか×になってしまい、先に進まない。
通常のeTax 「確定申告を作成する」ボタンから作った。




